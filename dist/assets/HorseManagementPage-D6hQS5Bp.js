import{r as e,j as s}from"./vendor-react-a0IVf7AC.js";import{h as r,$ as a,V as t,a2 as l,H as o,U as n,M as d}from"./form-components-Dej4WxZX.js";import{P as i}from"./PermissionGate-bbGAlBBf.js";import{B as c,L as m,c as h}from"./ui-components-Cdkvl4Hk.js";const u="owned",x={[u]:"Horses"},g=new Set,b=({stableId:n})=>{const{UserRoles:d,currentUser:b}=r(),[p,y]=e.useState(!1),[j,f]=e.useState(null),[N,w]=e.useState(null),[v,C]=e.useState(null),[A,k]=e.useState(null),[S,H]=e.useState({name:"",breed:"",color:"",age:""}),[D,B]=e.useState({isOpen:!1,horse:null,action:null}),{horses:I,loading:M,addHorse:O,updateHorse:T,deleteHorse:R,removeHorseFromStable:F,loadingState:E,error:$}=(s=>{const[l,o]=e.useState([]),[n,d]=e.useState(!0),[i,c]=e.useState(null),[m,h]=e.useState("fetch"),{stableRefreshKey:u}=r(),x=t(n,m),b=e.useCallback((async()=>{var e;if(s){if(g.has(s))return o([]),c(null),void d(!1);d(!0),h("fetch");try{const e=await a.getHorsesWithOwnersByStable(s),r=Array.isArray(e)?e.map((e=>({id:e.horseId,stableHorseId:e.id,name:e.horseName,breed:e.horseBreed,color:e.horseColor,owner:e.horseOwners&&e.horseOwners.length>0?{firstName:e.horseOwners[0],lastName:""}:null}))):[];Array.isArray(e)&&0===e.length&&g.add(s),o(r),c(null)}catch(r){if((404===r.status||404===r.statusCode)&&(r.message||(null==(e=r.details)?void 0:e.message)||"").includes("No horses"))return g.add(s),o([]),c(null),void d(!1);c(r.message||"Failed to load horses")}finally{d(!1)}}}),[s]);return e.useEffect((()=>{b()}),[b,u]),{horses:l,stableId:s,loading:n,error:i,loadingState:x,addHorse:async(e,r)=>{g.delete(s),d(!0),h("create");try{const t={horse:{name:e.name,breed:e.breed||null,color:e.color||null,age:e.age||null},stableId:s,userId:r};return await a.createHorseComposition(t),await b(),{success:!0}}catch(t){return c(t.message||"Failed to add horse"),{success:!1,error:t}}finally{d(!1)}},updateHorse:async(e,s)=>{d(!0),h("update");try{const r={id:e,name:s.name,breed:s.breed||null,color:s.color||null,age:s.age||null,coreInformation:s.coreInformation||null,description:s.description||null,currentBox:s.currentBox||null,weight:s.weight||null,height:s.height||null},t=await a.update(r),l=(null==t?void 0:t.data)||(null==t?void 0:t.value)||t;return await b(),{success:!0,data:l}}catch(r){return c(r.message||"Failed to update horse"),{success:!1,error:r}}finally{d(!1)}},deleteHorse:async e=>{d(!0),h("delete");try{const s=1===l.length,r=await a.delete(e);return s?(o([]),c(null),{success:!0,data:r}):(await b(),{success:!0,data:r})}catch(s){return c(s.message||"Failed to delete horse"),{success:!1,error:s}}finally{d(!1)}},refreshData:b}})(n),G=()=>{C(null),k(null)},U=()=>{G(),w("add"),H({name:"",breed:"",color:"",age:""}),y(!0)},Y=()=>{M||(y(!1),f(null),w(null),G())},q=e=>{const{name:s,value:r}=e.target;H((e=>({...e,[s]:r})))},z=async()=>{var e;let s;G();try{"add"===N?s=await O(S,null==b?void 0:b.id):"edit"===N&&j&&(s=await T(j.id,S)),s&&s.success?(k("add"===N?"🐴 New horse recruited for glory!":"✏️ Horse info polished to perfection!"),k("🐎 Message cleared. Back to the stables!"),Y()):s&&!s.success&&C((null==(e=s.error)?void 0:e.message)||s.message||"Operation failed")}catch(r){C(r.message||"An unexpected error occurred")}},P=e=>{if(!e)return"";try{const s=new Date(e);if(isNaN(s.getTime()))return"";const r=new Date;let a=r.getFullYear()-s.getFullYear();const t=r.getMonth()-s.getMonth();return(t<0||0===t&&r.getDate()<s.getDate())&&a--,`${a} years old`}catch(s){return""}},W=(()=>{const{horse:e,action:s}=D;return"delete"===s?{title:`Delete horse "${(null==e?void 0:e.name)||""}"?`,confirmText:"Delete",buttonType:"danger",iconBg:"bg-error-500",message:"This action will completely remove the horse from the system and cannot be undone."}:"remove"===s?{title:`Remove "${(null==e?void 0:e.name)||""}" from stable?`,confirmText:"Remove",buttonType:"warning",iconBg:"bg-warning-500",message:"The horse will remain in the system but will no longer be associated with this stable."}:{}})();return s.jsxs("section",{className:"bg-white rounded-lg shadow-sm md:shadow-md p-4 md:p-6",children:[s.jsxs("header",{className:"flex justify-between items-center mb-4",children:[s.jsxs("div",{children:[s.jsx("h2",{className:"font-bold text-lg md:text-xl",children:x[u]}),s.jsx(i,{requiredRoles:[d.MANAGER,d.ADMIN],fallback:s.jsx("p",{className:"text-sm mt-1 text-gray",children:"Contact a stable administrator to manage horses"}),children:s.jsx("p",{className:"text-sm mt-1 text-gray",children:"Manage the horses in your stable"})})]}),s.jsxs(i,{requiredRoles:[d.MANAGER,d.ADMIN],children:[s.jsx(c,{variant:"icon",size:"small",className:"!bg-primary !rounded-full md:hidden",onClick:U,"aria-label":"Add new horse",children:s.jsx(l,{className:"h-5 w-5 text-white",strokeWidth:3})}),s.jsx(c,{type:"primary",onClick:U,className:"hidden md:flex md:items-center","aria-label":"Add new horse",children:"Add Horse"})]})]}),M&&!p?s.jsxs("div",{children:[s.jsx(m,{size:"medium"}),s.jsx("p",{className:"mt-2",children:E.getMessage()})]}):$?s.jsxs("div",{className:"bg-red-50 border-l-4 border-red-500 p-4 rounded",children:[s.jsxs("p",{className:"text-red-700",children:["Error loading horses: ",$]}),s.jsx(c,{type:"primary",onClick:()=>window.location.reload(),className:"mt-2",children:"Retry"})]}):s.jsx("div",{className:"max-h-64 md:max-h-80 lg:max-h-96 overflow-y-auto pr-1 space-y-1",children:0===I.length?s.jsxs("div",{className:"text-center py-8",children:[s.jsx("p",{className:"text-gray mb-2",children:"No horses added to this stable yet"}),s.jsx("p",{className:"text-sm text-gray",children:'Use the "Add Horse" button to add your first horse'})]}):I.map(((e,r)=>s.jsxs("article",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between py-3 px-3 bg-light/30 rounded-lg mb-2",children:[s.jsxs("div",{className:"mb-2 sm:mb-0",children:[s.jsx("h3",{className:"text-base font-medium",children:e.name||"Unnamed Horse"}),s.jsx("p",{className:"text-sm text-gray",children:[e.breed,e.color,P(e.age)].filter(Boolean).join(", ")||"No additional details"}),e.owner&&s.jsxs("p",{className:"text-xs text-gray mt-1",children:["Owner: ",e.owner.firstName," ",e.owner.lastName]})]}),s.jsx(i,{requiredRoles:[d.MANAGER,d.ADMIN],children:s.jsxs("div",{className:"flex space-x-2 mt-2 sm:mt-0",children:[s.jsx(c,{type:"icon",onClick:()=>(e=>{w("edit"),f(e),H({name:e.name||"",breed:e.breed||"",color:e.color||"",age:e.age?new Date(e.age).toISOString().split("T")[0]:""}),y(!0)})(e),"aria-label":`Edit ${e.name||"this horse"}`,className:"text-primary text-sm",children:"Edit"}),s.jsx(c,{type:"icon",onClick:()=>(e=>{B({isOpen:!0,horse:e,action:"delete"})})(e),"aria-label":`Delete ${e.name||"this horse"}`,className:"text-error-500 text-sm",children:"Delete"})]})})]},`horse-${e.id||r}`)))}),p&&s.jsx("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center z-50",role:"dialog","aria-modal":"true",children:s.jsxs("div",{className:"bg-white rounded-lg border border-primary-light w-11/12 max-w-md p-4",children:[s.jsx("h3",{className:"mb-4 text-lg font-bold",children:"add"===N?"Add New Horse":`Edit ${null==j?void 0:j.name}`}),A&&s.jsx("div",{className:"bg-green-50 border-l-4 border-green-500 p-2 mb-4 rounded",children:s.jsx("p",{className:"text-green-700",children:A})}),v&&s.jsx("div",{className:"bg-red-50 border-l-4 border-red-500 p-2 mb-4 rounded",children:s.jsx("p",{className:"text-red-700",children:v})}),s.jsxs("form",{className:"space-y-4",onSubmit:e=>{e.preventDefault(),z()},children:[s.jsxs("div",{children:[s.jsx("label",{htmlFor:"horseName",className:"block text-sm font-medium mb-1",children:"Horse Name *"}),s.jsx("input",{type:"text",id:"horseName",name:"name",value:S.name,onChange:q,className:"w-full p-2 border border-gray-300 rounded-md","aria-required":"true"})]}),s.jsxs("div",{children:[s.jsx("label",{htmlFor:"horseBreed",className:"block text-sm font-medium mb-1",children:"Breed"}),s.jsx("input",{type:"text",id:"horseBreed",name:"breed",value:S.breed,onChange:q,className:"w-full p-2 border border-gray-300 rounded-md"})]}),s.jsxs("div",{children:[s.jsx("label",{htmlFor:"horseColor",className:"block text-sm font-medium mb-1",children:"Color"}),s.jsx("input",{type:"text",id:"horseColor",name:"color",value:S.color,onChange:q,className:"w-full p-2 border border-gray-300 rounded-md"})]}),s.jsxs("div",{children:[s.jsx("label",{htmlFor:"horseAge",className:"block text-sm font-medium mb-1",children:"Birth Date"}),s.jsx("input",{type:"date",id:"horseAge",name:"age",value:S.age,onChange:q,className:"w-full p-2 border border-gray-300 rounded-md",max:(new Date).toISOString().split("T")[0]}),s.jsx("p",{className:"text-xs text-gray mt-1",children:"Format: YYYY-MM-DD"})]})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-3 mt-6",children:[s.jsx(c,{type:"secondary",onClick:Y,disabled:M,children:"Cancel"}),s.jsx(c,{type:"primary",onClick:z,disabled:"add"===N&&!S.name||"edit"===N&&!S.name||M||A,children:M?s.jsx(m,{size:"small",className:"mx-auto"}):"add"===N?"Add Horse":"Save Changes"})]})]})}),s.jsx(h,{isOpen:D.isOpen,onClose:()=>B({isOpen:!1,horse:null,action:null}),onConfirm:async()=>{const{horse:e,action:s}=D,r="delete"===s?await R(e.id):await F(e.stableHorseId);(null==r?void 0:r.success)&&B({isOpen:!1,horse:null,action:null})},loading:M,title:W.title,confirmButtonText:W.confirmText,cancelButtonText:"Cancel",confirmButtonType:W.buttonType,icon:s.jsx(o,{size:70,backgroundColor:W.iconBg,iconColor:"text-white"}),children:s.jsx("p",{children:W.message})})]})},p=()=>{const{currentStable:e,currentUser:a}=r();return s.jsx(i,{requiredRoles:[n.ADMIN,n.MANAGER],children:s.jsxs("div",{className:"flex flex-col min-h-screen bg-background pb-20 overflow-y-hidden",children:[s.jsx("div",{className:"bg-primary-light lg:bg-background",children:s.jsx(d,{title:"Manage Horses",showCloseBtn:!1,onCloseClick:()=>window.history.back()})}),s.jsx("div",{className:"flex-1 px-4 py-6 md:px-8 lg:px-16 xl:px-80 ",children:s.jsxs("div",{className:"max-w-4xl mx-auto space-y-6",children:[s.jsx(b,{stableId:null==e?void 0:e.id,userId:null==a?void 0:a.id}),s.jsx("div",{className:"hidden lg:flex justify-start",children:s.jsx(c,{type:"secondary",onClick:()=>{window.history.back()},className:"w-auto",children:"Go back"})})]})})]})})};export{p as default};

import{e as R,b as J,j as e,B as f,Q as V,L,k as X,U as $,M as Z}from"./index-BZdNtiSy.js";import{r as i}from"./vendor-router-BURTDQSf.js";import{P as M}from"./PermissionGate-BlmUKxEH.js";import{H as ee}from"./HandRaisedIcon-CPMQ79lY.js";import E from"./horseService-DFbqJ7E3.js";import"./vendor-react-DavUf6mE.js";import"./vendor-forms-DlkW-UdB.js";const P={OWNED:"owned"},se={[P.OWNED]:"Horses"},k=new Set,re=n=>{const[d,g]=i.useState([]),[y,l]=i.useState(!0),[N,c]=i.useState(null),[x,p]=i.useState("fetch"),{stableRefreshKey:A}=R(),j=J(y,x),m=i.useCallback(async()=>{if(n){if(k.has(n)){console.warn(`Stable ${n} is known to be empty - skipping API call`),g([]),c(null),l(!1);return}l(!0),p("fetch");try{const a=await E.getHorsesWithOwnersByStable(n),t=Array.isArray(a)?a.map(r=>({id:r.horseId,stableHorseId:r.id,name:r.horseName,breed:r.horseBreed,color:r.horseColor,owner:r.horseOwners&&r.horseOwners.length>0?{firstName:r.horseOwners[0],lastName:""}:null})):[];Array.isArray(a)&&a.length===0&&k.add(n),g(t),c(null)}catch(a){if((a.status===404||a.statusCode===404)&&(a.message||a.details?.message||"").includes("No horses")){k.add(n),g([]),c(null),l(!1);return}c(a.message||"Failed to load horses")}finally{l(!1)}}},[n]),w=async(a,t)=>{k.delete(n),l(!0),p("create");try{const r={horse:{name:a.name,breed:a.breed||null,color:a.color||null,age:a.age||null},stableId:n,userId:t};return await E.createHorseComposition(r),await m(),{success:!0}}catch(r){return console.error("Error adding horse:",r),c(r.message||"Failed to add horse"),{success:!1,error:r}}finally{l(!1)}},u=async(a,t)=>{l(!0),p("update");try{const r={id:a,name:t.name,breed:t.breed||null,color:t.color||null,age:t.age||null,coreInformation:t.coreInformation||null,description:t.description||null,currentBox:t.currentBox||null,weight:t.weight||null,height:t.height||null},h=await E.update(r),O=h?.data||h?.value||h;return await m(),{success:!0,data:O}}catch(r){return console.error("Error updating horse:",r),c(r.message||"Failed to update horse"),{success:!1,error:r}}finally{l(!1)}},C=async a=>{l(!0),p("delete");try{const t=d.length===1,r=await E.delete(a);return t?(g([]),c(null),{success:!0,data:r}):(await m(),{success:!0,data:r})}catch(t){return console.error("Error deleting horse:",t),c(t.message||"Failed to delete horse"),{success:!1,error:t}}finally{l(!1)}};return i.useEffect(()=>{m()},[m,A]),{horses:d,stableId:n,loading:y,error:N,loadingState:j,addHorse:w,updateHorse:u,deleteHorse:C,refreshData:m}},te=({stableId:n})=>{const{UserRoles:d,currentUser:g}=R(),[y,l]=i.useState(!1),[N,c]=i.useState(null),[x,p]=i.useState(null),[A,j]=i.useState(null),[m,w]=i.useState(null),[u,C]=i.useState({name:"",breed:"",color:"",age:""}),[a,t]=i.useState({isOpen:!1,horse:null,action:null}),{horses:r,loading:h,addHorse:O,updateHorse:U,deleteHorse:Y,removeHorseFromStable:q,loadingState:z,error:T}=re(n),B=()=>{j(null),w(null)},D=()=>{B(),p("add"),C({name:"",breed:"",color:"",age:""}),l(!0)},W=s=>{p("edit"),c(s),C({name:s.name||"",breed:s.breed||"",color:s.color||"",age:s.age?new Date(s.age).toISOString().split("T")[0]:""}),l(!0)},_=s=>{t({isOpen:!0,horse:s,action:"delete"})},F=()=>{h||(l(!1),c(null),p(null),B())},S=s=>{const{name:o,value:b}=s.target;C(H=>({...H,[o]:b}))},I=async()=>{B();let s;try{x==="add"?s=await O(u,g?.id):x==="edit"&&N&&(s=await U(N.id,u)),s&&s.success?(w(x==="add"?"🐴 New horse recruited for glory!":"✏️ Horse info polished to perfection!"),w("🐎 Message cleared. Back to the stables!"),F()):s&&!s.success&&j(s.error?.message||s.message||"Operation failed")}catch(o){j(o.message||"An unexpected error occurred")}},K=()=>{const{horse:s,action:o}=a;return o==="delete"?{title:`Delete horse "${s?.name||""}"?`,confirmText:"Delete",buttonType:"danger",iconBg:"bg-error-500",message:"This action will completely remove the horse from the system and cannot be undone."}:o==="remove"?{title:`Remove "${s?.name||""}" from stable?`,confirmText:"Remove",buttonType:"warning",iconBg:"bg-warning-500",message:"The horse will remain in the system but will no longer be associated with this stable."}:{}},Q=s=>{if(!s)return"";try{const o=new Date(s);if(isNaN(o.getTime()))return"";const b=new Date;let H=b.getFullYear()-o.getFullYear();const G=b.getMonth()-o.getMonth();return(G<0||G===0&&b.getDate()<o.getDate())&&H--,`${H} years old`}catch(o){return console.error("Error formatting age:",o),""}},v=K();return e.jsxs("section",{className:"bg-white rounded-lg shadow-sm md:shadow-md p-4 md:p-6",children:[e.jsxs("header",{className:"flex justify-between items-center mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"font-bold text-lg md:text-xl",children:se[P.OWNED]}),e.jsx(M,{requiredRoles:[d.MANAGER,d.ADMIN],fallback:e.jsx("p",{className:"text-sm mt-1 text-gray",children:"Contact a stable administrator to manage horses"}),children:e.jsx("p",{className:"text-sm mt-1 text-gray",children:"Manage the horses in your stable"})})]}),e.jsxs(M,{requiredRoles:[d.MANAGER,d.ADMIN],children:[e.jsx(f,{variant:"icon",size:"small",className:"!bg-primary !rounded-full md:hidden",onClick:D,"aria-label":"Add new horse",children:e.jsx(V,{className:"h-5 w-5 text-white",strokeWidth:3})}),e.jsx(f,{type:"primary",onClick:D,className:"hidden md:flex md:items-center","aria-label":"Add new horse",children:"Add Horse"})]})]}),h&&!y?e.jsxs("div",{children:[e.jsx(L,{size:"medium"}),e.jsx("p",{className:"mt-2",children:z.getMessage()})]}):T?e.jsxs("div",{className:"bg-red-50 border-l-4 border-red-500 p-4 rounded",children:[e.jsxs("p",{className:"text-red-700",children:["Error loading horses: ",T]}),e.jsx(f,{type:"primary",onClick:()=>window.location.reload(),className:"mt-2",children:"Retry"})]}):e.jsx("div",{className:"max-h-64 md:max-h-80 lg:max-h-96 overflow-y-auto pr-1 space-y-1",children:r.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("p",{className:"text-gray mb-2",children:"No horses added to this stable yet"}),e.jsx("p",{className:"text-sm text-gray",children:'Use the "Add Horse" button to add your first horse'})]}):r.map((s,o)=>e.jsxs("article",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between py-3 px-3 bg-light/30 rounded-lg mb-2",children:[e.jsxs("div",{className:"mb-2 sm:mb-0",children:[e.jsx("h3",{className:"text-base font-medium",children:s.name||"Unnamed Horse"}),e.jsx("p",{className:"text-sm text-gray",children:[s.breed,s.color,Q(s.age)].filter(Boolean).join(", ")||"No additional details"}),s.owner&&e.jsxs("p",{className:"text-xs text-gray mt-1",children:["Owner: ",s.owner.firstName," ",s.owner.lastName]})]}),e.jsx(M,{requiredRoles:[d.MANAGER,d.ADMIN],children:e.jsxs("div",{className:"flex space-x-2 mt-2 sm:mt-0",children:[e.jsx(f,{type:"icon",onClick:()=>W(s),"aria-label":`Edit ${s.name||"this horse"}`,className:"text-primary text-sm",children:"Edit"}),e.jsx(f,{type:"icon",onClick:()=>_(s),"aria-label":`Delete ${s.name||"this horse"}`,className:"text-error-500 text-sm",children:"Delete"})]})})]},`horse-${s.id||o}`))}),y&&e.jsx("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center z-50",role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"bg-white rounded-lg border border-primary-light w-11/12 max-w-md p-4",children:[e.jsx("h3",{className:"mb-4 text-lg font-bold",children:x==="add"?"Add New Horse":`Edit ${N?.name}`}),m&&e.jsx("div",{className:"bg-green-50 border-l-4 border-green-500 p-2 mb-4 rounded",children:e.jsx("p",{className:"text-green-700",children:m})}),A&&e.jsx("div",{className:"bg-red-50 border-l-4 border-red-500 p-2 mb-4 rounded",children:e.jsx("p",{className:"text-red-700",children:A})}),e.jsxs("form",{className:"space-y-4",onSubmit:s=>{s.preventDefault(),I()},children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"horseName",className:"block text-sm font-medium mb-1",children:"Horse Name *"}),e.jsx("input",{type:"text",id:"horseName",name:"name",value:u.name,onChange:S,className:"w-full p-2 border border-gray-300 rounded-md","aria-required":"true"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"horseBreed",className:"block text-sm font-medium mb-1",children:"Breed"}),e.jsx("input",{type:"text",id:"horseBreed",name:"breed",value:u.breed,onChange:S,className:"w-full p-2 border border-gray-300 rounded-md"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"horseColor",className:"block text-sm font-medium mb-1",children:"Color"}),e.jsx("input",{type:"text",id:"horseColor",name:"color",value:u.color,onChange:S,className:"w-full p-2 border border-gray-300 rounded-md"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"horseAge",className:"block text-sm font-medium mb-1",children:"Birth Date"}),e.jsx("input",{type:"date",id:"horseAge",name:"age",value:u.age,onChange:S,className:"w-full p-2 border border-gray-300 rounded-md",max:new Date().toISOString().split("T")[0]}),e.jsx("p",{className:"text-xs text-gray mt-1",children:"Format: YYYY-MM-DD"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 mt-6",children:[e.jsx(f,{type:"secondary",onClick:F,disabled:h,children:"Cancel"}),e.jsx(f,{type:"primary",onClick:I,disabled:x==="add"&&!u.name||x==="edit"&&!u.name||h||m,children:h?e.jsx(L,{size:"small",className:"mx-auto"}):x==="add"?"Add Horse":"Save Changes"})]})]})}),e.jsx(X,{isOpen:a.isOpen,onClose:()=>t({isOpen:!1,horse:null,action:null}),onConfirm:async()=>{const{horse:s,action:o}=a;(o==="delete"?await Y(s.id):await q(s.stableHorseId))?.success&&t({isOpen:!1,horse:null,action:null})},loading:h,title:v.title,confirmButtonText:v.confirmText,cancelButtonText:"Cancel",confirmButtonType:v.buttonType,icon:e.jsx(ee,{size:70,backgroundColor:v.iconBg,iconColor:"text-white"}),children:e.jsx("p",{children:v.message})})]})},me=()=>{const{currentStable:n,currentUser:d}=R(),g=()=>{window.history.back()};return e.jsx(M,{requiredRoles:[$.ADMIN,$.MANAGER],children:e.jsxs("div",{className:"flex flex-col min-h-screen bg-background pb-20 overflow-y-hidden",children:[e.jsx("div",{className:"bg-primary-light lg:bg-background",children:e.jsx(Z,{title:"Manage Horses",showCloseBtn:!1,onCloseClick:()=>window.history.back()})}),e.jsx("div",{className:"flex-1 px-4 py-6 md:px-8 lg:px-16 xl:px-80 ",children:e.jsxs("div",{className:"max-w-4xl mx-auto space-y-6",children:[e.jsx(te,{stableId:n?.id,userId:d?.id}),e.jsx("div",{className:"hidden lg:flex justify-start",children:e.jsx(f,{type:"secondary",onClick:g,className:"w-auto",children:"Go back"})})]})})]})})};export{me as default};

import{j as s,u as se,b as z,z as L,A as H,D as W,d as ae,K as ne,R as G,B as U,L as _,O as E,M as re,F as ie,k as oe}from"./index-uCdg3-W8.js";import{r as n,R as k,a as le}from"./vendor-router-BURTDQSf.js";import{F as $}from"./FormMessage-DDtpDkQr.js";import{H as ce}from"./HandRaisedIcon-8TPnBXoX.js";import{u as ue}from"./vendor-forms-DlkW-UdB.js";import{L as de}from"./LocationPinIcon-CG_pxMjg.js";const fe=({className:e="",size:t=24})=>s.jsxs("svg",{width:t,height:t,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:e,children:[s.jsx("path",{d:"M3 21h18"}),s.jsx("path",{d:"M5 21V7l8-4v18"}),s.jsx("path",{d:"M19 21V11l-6-3"}),s.jsx("rect",{x:"9",y:"9",width:"4",height:"4"}),s.jsx("rect",{x:"9",y:"14",width:"4",height:"4"})]});function he(){const[e,t]=n.useState(!1),[c,u]=n.useState(null),[o,d]=n.useState(null),[a,l]=n.useState("create"),[i,h]=n.useState(0),{user:y}=se(),g=6e4,x=z(e,a),S=n.useCallback(()=>Date.now()-i<g,[i]),w=n.useMemo(()=>S()?Math.ceil((g-(Date.now()-i))/1e3):0,[S,i]),C=async p=>{if(!y||!y.id)return u(L("You need to be logged in to send a join request")),{success:!1};if(!p||!p.stableId)return u(L("No stable selected")),{success:!1};if(S()){const r=`Please wait ${w} seconds before sending another join request`;return d(H(r)),{success:!1,throttled:!0,timeRemaining:w,message:r}}t(!0),l("create"),u(null),d(null),h(Date.now());const m={userId:y.id,stableId:p.stableId||p.id};try{const r=await W.createStableJoinRequest(m);if(r&&(r.isSuccess||r.success)){const b=`You request to join ${p.stableName?.name||p.stableName||"stable"} has been sent!`;return d(ae(b)),{success:!0,message:b}}return u(L("Unexpected response format")),{success:!1,message:"Unexpected response format"}}catch(r){if(r.type===ne.VALIDATION&&r.status===400){const b=r.details?.message||r.message||"";if(b.toLowerCase().includes("already")||b.toLowerCase().includes("duplicate")||b.toLowerCase().includes("member")){const N="You're already a member of this stable.";return d(H(N)),{success:!1,alreadyMember:!0,message:N}}return u(L(b)),{success:!1,message:b}}const f=r?.message||"An error occurred while sending the join request";return u(L(f)),{success:!1,message:f}}finally{t(!1)}},M=n.useCallback(()=>{t(!1),u(null),d(null)},[]);return{loading:e,error:c,message:o,loadingState:x,sendJoinRequest:C,resetState:M,isThrottled:S(),throttleTimeRemaining:w}}const ge=(e={})=>{const{dataPath:t="data",successPath:c="success",messagePath:u="message",alternativeSuccessPath:o="isSuccess",alternativeDataPath:d="value"}=e;return a=>a?Array.isArray(a)?{success:!0,data:a,message:"Search completed"}:a[c]!==void 0?a[c]?{success:!0,data:a[t]||[],message:a[u]||"Search completed"}:{success:!1,data:[],message:a[u]||"Search failed"}:a[o]!==void 0?a[o]?{success:!0,data:a[d]||[],message:a[u]||"Search completed"}:{success:!1,data:[],message:a[u]||"Search failed"}:(console.warn("Unexpected response format:",a),{success:!0,data:[],message:"No results found"}):{success:!1,data:[],message:"No response from server"}},me={entityType:"generic",searchFn:null,idField:"id",labelField:"name",secondaryField:"description",imageField:"image",placeHolderText:"Search for...",actionButton:"Select",cancelButton:"Cancel",noResultsText:"No results found. Try another search term.",errorText:"An error occurred while searching. Please try again.",loadingText:"Searching...",selectionMode:"single",searchParams:{page:0,pageSize:10}};class ye{constructor(t){this.config={...me,entityType:t||"generic"}}withSearchFunction(t,c={}){const u=ge(c);return this.config.searchFn=async o=>{try{const d={searchTerm:o,page:0,pageSize:10,...c.params},a=await t(d);return u(a)}catch(d){return console.error(`${this.config.entityType} search error:`,d),{success:!1,data:[],message:d.message||"Search failed",error:d}}},this}withFields(t={}){const c={idField:t.idField||"id",labelField:t.labelField||"name",secondaryField:t.secondaryField,imageField:t.imageField,tertiaryField:t.tertiaryField,typeField:t.typeField};return Object.entries(c).forEach(([u,o])=>{o!==void 0&&(this.config[u]=o)}),this}withUIText(t={}){const c={placeholderText:t.placeholder,actionButtonText:t.actionButton,cancelButtonText:t.cancelButton,noResultsText:t.noResults,errorText:t.error,loadingText:t.loading,emptySearchPrompt:t.emptyPrompt};return Object.entries(c).forEach(([u,o])=>{o!==void 0&&(this.config[u]=o)}),this}withResultRenderer(t){return this.config.resultItemRenderer=t,this}withLayout(t,c=1){return this.config.layout=t==="grid"?"grid":"list",t==="grid"&&(this.config.columns=c),this}withCustomProps(t={}){return this.config={...this.config,...t},this}build(){return this.config.entityType||console.warn("Search config is missing entityType"),this.config.searchFn||console.warn(`Search config for ${this.config.entityType||"unknown"} is missing searchFn`),this.config}}const V=(e={})=>new ye("stable").withSearchFunction(W.search,{alternativeDataPath:"value",alternativeSuccessPath:"isSuccess"}).withFields({idField:"id",labelField:"name",secondaryField:"county",tertiaryField:"address",typeField:"type",imageField:"image"}).withUIText({placeholder:"Search for stable name...",actionButton:"Join",cancelButton:"Return",noResults:"Can't find a stable with that name. Try another name.",error:"An error occurred while searching. Try again later.",loading:"Searching for stables...",emptyPrompt:"Enter a stable name to search"}).withCustomProps(e).build(),K=V(),q={[G.STABLE_ONBOARDING]:K},B={stable:K},pe=e=>{if(q[e])return q[e];for(const[t,c]of Object.entries(q))if(e.startsWith(t)&&t!==G.HOME)return c;return e.includes("/stable"),B.stable},Q=n.createContext(void 0),O=()=>{const e=n.useContext(Q);if(e===void 0)throw new Error("useSearch must be used with a SearchProvider");return e},xe=({onCancel:e,onAction:t,cancelButtonClassName:c="",actionsContainerClassName:u=""})=>{const{config:o,loading:d,selectedItem:a,executeActionForSelectedItem:l}=O(),i=n.useCallback(()=>{t&&a&&l(t)},[t,a,l]),h=n.useCallback(()=>{e&&e()},[e]);return s.jsxs("div",{className:`space-y-3 ${u}`,children:[a&&t&&s.jsx(U,{type:"primary",onClick:i,disabled:d,className:"w-full","data-action-button":"primary",children:o?.actionButtonText||"Select"}),s.jsx("div",{className:"block lg:hidden",children:s.jsx(U,{type:"secondary",onClick:h,disabled:d,className:`w-full ${c}`,"data-action-button":"secondary",children:o?.cancelButtonText||"Cancel"})})]})},A=k.memo(xe),be=({className:e="",inputClassName:t="",ariaLabel:c,onFocus:u,autoFocus:o=!1,desktopView:d=!1,maintainFocus:a=!0})=>{const{query:l,handleInputChange:i,loading:h,loadingState:y,config:g,results:x,handleSelectItem:S,selectedItem:w,executeActionForSelectedItem:C}=O(),[M,p]=n.useState(l||""),m=n.useRef(!1);n.useEffect(()=>{!m.current&&l!==M&&p(l||"")},[l,M]);const r=n.useRef(null),f=n.useRef(h),b=g?.placeholderText||"Search...",N=n.useRef(null),j=n.useCallback(v=>{const F=v.target.value;p(F),m.current=!0,N.current&&clearTimeout(N.current),N.current=setTimeout(()=>{m.current=!1,i({target:{value:F}})},400)},[i]);n.useEffect(()=>{f.current&&!h&&a&&!d&&setTimeout(()=>{if(r.current&&document.activeElement?.tagName!=="INPUT"){r.current.focus();const v=r.current.value.length;r.current.setSelectionRange(v,v)}},100),f.current=h},[h,a,d]),n.useEffect(()=>{o&&!d&&window.innerWidth<1024&&r.current&&setTimeout(()=>{r.current.focus()},100)},[o,d]);const R=n.useCallback(v=>{u&&u(v)},[u]),T=n.useCallback(v=>{if(v.key==="Enter"){v.preventDefault(),w?C():x&&x.length>0&&(S(x[0]),setTimeout(()=>{C()},10));return}if(v.key==="ArrowDown"&&x&&x.length>0){v.preventDefault();const F=document.querySelector('[role="option"]');F&&F.focus()}},[w,x,C,S]);return s.jsxs("div",{className:`relative ${e}`,children:[s.jsx("input",{ref:r,type:"text",value:M,onChange:j,placeholder:b,className:`w-full px-3 py-2 border border-light rounded-lg focus:outline-none focus:ring-2 focus:ring-primary ${t} ${h?"pr-10":""}`,"aria-label":c||b,"aria-autocomplete":"list",autoComplete:"off",onFocus:R,autoFocus:o,disabled:h,role:"searchbox","aria-busy":h,"aria-controls":"search-results",onKeyDown:T}),h&&s.jsx("div",{className:`absolute inset-0 flex items-center justify-center bg-white
      transition-opacity duration-200 opacity-100 z-10`,role:"alert",children:s.jsx(_,{size:"small",withMargin:!1,className:"text-primary"})}),h&&s.jsx("div",{className:"sr-only","aria-live":"polite",children:y?.getMessage()||"Searching..."})]})},Y=k.memo(be),D=e=>e*(Math.PI/180),P=(e,t,c,u)=>{const d=D(c-e),a=D(u-t),l=Math.sin(d/2)*Math.sin(d/2)+Math.cos(D(e))*Math.cos(D(c))*Math.sin(a/2)*Math.sin(a/2);return 6371*(2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l)))},Se=e=>e==null?"":`${e.toFixed(1)} km`,je=(e,t)=>!e||!t?null:`https://www.google.com/maps/dir/?api=1&destination=${e},${t}&travelmode=driving`,X=(e={})=>{const[t,c]=n.useState(null),[u,o]=n.useState(!1),[d,a]=n.useState(null),[l,i]=n.useState(null),[h,y]=n.useState(null),x={...{autoGetUserLocation:!1},...e},S=n.useCallback(()=>{if(!navigator.geolocation){y("not-supported");return}y("requesting"),navigator.geolocation.getCurrentPosition(r=>{const{latitude:f,longitude:b}=r.coords;i({latitude:f,longitude:b}),y("success")},r=>{console.error("Error getting location:",r),y("error")})},[]);n.useEffect(()=>{x.autoGetUserLocation&&S()},[x.autoGetUserLocation,S]);const w=n.useCallback((r,f,b,N)=>P(r,f,b,N),[]),C=n.useCallback(r=>!l||!r||!r.latitude||!r.longitude?null:P(l.latitude,l.longitude,r.latitude,r.longitude),[l]),M=n.useCallback((r,f)=>je(r,f),[]),p=n.useCallback(r=>Se(r),[]),m=n.useCallback(async r=>{if(!(!r||r.trim()==="")){o(!0),a(null);try{const f=await E.get(`/api/stable-location/${r}`);if(f.isSuccess===!0){let b=f.value;if(l&&f.value.latitude&&f.value.longitude){const N=P(l.latitude,l.longitude,f.value.latitude,f.value.longitude);b={...f.value,distance:N}}return c(b),o(!1),b}return a(L(f.message||"Could not find location data for this postcode")),c(null),null}catch{return a(L("Failed to fetch location data. Please check your connection.")),c(null),null}finally{o(!1)}}},[l]);return{locationData:t,isLoading:u,message:d,fetchLocationData:m,userLocation:l,userLocationStatus:h,getUserLocation:S,getDistanceToLocation:C,calculateDistance:w,getDirectionsUrl:M,formatDistance:p}},we=({directionsUrl:e,distance:t,locationName:c,className:u="",iconSize:o=14,showLabel:d=!0})=>{const a=t!==void 0?`${t.toFixed(1)} km ${d?"from you":""}`:"";return s.jsxs("a",{href:e,target:"_blank",rel:"noopener noreferrer",className:`text-xs font-semibold text-primary truncate flex items-center gap-1 hover:underline ${u}`,"aria-label":`Get directions to ${c||"location"}${t?`, ${t.toFixed(1)} km away`:""}`,onClick:l=>l.stopPropagation(),children:[s.jsx(de,{size:o}),a]})},Ce=({latitude:e,longitude:t,locationName:c,distance:u,...o})=>{const{userLocation:d,calculateDistance:a,getDirectionsUrl:l}=X();if(!e||!t)return null;const i=u!==void 0?u:d?a(d.latitude,d.longitude,e,t):void 0,h=l?l(e,t):`https://www.google.com/maps/dir/?api=1&destination=${e},${t}&travelmode=driving`;return s.jsx(we,{directionsUrl:h,distance:i,locationName:c,...o})},J=({item:e,isSelected:t,config:c,onJoinStable:u,actionLabel:o="Join",index:d,...a})=>{const[l,i]=n.useState(!1),[h,y]=n.useState(!1),g=e[c?.labelField||"name"],x=e.county||"",S=e[c?.imageField||"image"],w=e.type||"",C=r=>{r.stopPropagation();const f=window.innerWidth<768?500:400;setTimeout(()=>{u&&u({stableId:e.id,stableName:e,action:"join"}),i(!1)},f)},M=r=>{r.stopPropagation(),C(r)},p="group flex items-center justify-between p-3 border border-primary rounded-lg cursor-pointer mb-2 bg-white hover:bg-primary-light focus:outline-none focus:ring-2 focus:ring-primary transition-all duration-150 active:scale-96 active:bg-primary-light",m=t?"bg-primary-light hover:bg-primary active:bg-primary":"";return s.jsxs("li",{className:`${p} ${m}`,onClick:C,tabIndex:0,onFocus:r=>{y(!0);const f=r.currentTarget.querySelector("button");f&&(f.style.opacity=1,f.style.transform="scale(1)")},onBlur:r=>{y(!1);const f=r.currentTarget.querySelector("button");f&&window.innerWidth>=768&&(f.style.opacity=t?1:0)},onMouseEnter:r=>{const f=r.currentTarget.querySelector("button");f&&(f.style.opacity=1)},onMouseLeave:r=>{const f=r.currentTarget.querySelector("button");f&&(f.style.opacity=0)},"data-index":d,"aria-label":`${g}, ${x||"no county"}, ${w||"stable"}, click to join`,...a,children:[s.jsxs("div",{className:"flex items-center flex-grow",children:[s.jsx("div",{className:"w-12 h-12 bg-primary-light rounded-full flex items-center justify-center overflow-hidden flex-shrink-0 border border-white",children:S?s.jsx("img",{src:S,alt:`${g}`,className:"w-full h-full object-cover",loading:"lazy"}):s.jsx(fe,{className:"w-7 h-7 text-primary bg-primary-light"})}),s.jsxs("div",{className:"ml-3 flex-grow min-w-0",children:[s.jsx("div",{className:"font-medium text-base truncate",children:g}),x&&s.jsx("div",{className:"text-sm text-gray-600 truncate",children:x}),w&&s.jsx("div",{className:"text-xs text-gray-600 truncate",children:w}),c?.entityType==="stable"&&e.latitude&&e.longitude&&s.jsx(Ce,{latitude:e.latitude,longitude:e.longitude,distance:e.distance,locationName:g})]})]}),s.jsx(U,{type:"primary",size:"small",className:"ml-2 whitespace-nowrap transition-all duration-300",onClick:M,style:{opacity:window.innerWidth<768?1:0},tabIndex:-1,"aria-hidden":"true","data-action-button":"visual-indicator",children:o||"Join"})]})};k.memo(J,(e,t)=>e.isSelected===t.isSelected&&e.item[e.config?.idField||"id"]===t.item[t.config?.idField||"id"]&&e.item[e.config?.labelField||"name"]===t.item[t.config?.labelField||"name"]&&e.item[e.config?.secondaryField]===t.item[t.config?.secondaryField]&&e.item.county===t.item.county&&e.item.type===t.item.type);const ve={ListItemRenderer:J},{ListItemRenderer:Te}=ve,Fe=k.memo(Te,(e,t)=>e.isSelected===t.isSelected&&e.item[e.config?.idField||"id"]===t.item[t.config?.idField||"id"]),Re=({className:e="",maxHeight:t="20rem",onItemSelect:c,onItemFocus:u=null})=>{const{results:o,loading:d,error:a,message:l,config:i,query:h,loadingState:y,handleSelectItem:g,handleItemFocus:x,isItemSelected:S}=O(),w=n.useRef(null),C=n.useRef(h),[M,p]=n.useState(!1);n.useEffect(()=>{if(d)p(!1);else if(o.length>0){const j=setTimeout(()=>{p(!0)},50);return()=>clearTimeout(j)}else p(!1)},[d,o.length]),n.useEffect(()=>{w.current&&o.length>0&&o.length!==C.current&&(w.current.scrollTop=0,C.current=o.length)},[o]);const m=n.useCallback(j=>{g(j),c&&c(j)},[g,c]),r=n.useCallback(j=>{u&&u(j),x?x(j):g(j)},[g,x,u]),f=i?.resultItemRenderer||Fe,b=n.useMemo(()=>{if(o.length===0)return null;const{layout:j="list",columns:R=1}=i||{};if(j==="grid"){const T=R===2?"grid grid-cols-1 sm:grid-cols-2 gap-3":"grid grid-cols-1 gap-3";return s.jsx("div",{className:T,role:"region","aria-label":`Search results for ${i?.entityType||"items"}`,children:o.map((v,F)=>s.jsx(f,{item:v,isSelected:S(v),onSelect:m,onFocus:r,onJoinStable:c,config:i,index:F,"data-index":F},v[i?.idField||"id"]||F))})}return s.jsx("ul",{className:"space-y-2",role:"list","aria-label":`Search results for ${i?.entityType||"items"}`,children:o.map((T,v)=>s.jsx(f,{item:T,isSelected:S(T),onSelect:m,onFocus:r,onJoinStable:c,config:i,index:v,"data-index":v},T[i?.idField||"id"]||v))})},[o,i,S,m,r,c]),N=n.useMemo(()=>({maxHeight:t,minHeight:o.length>0?"9rem":"auto",position:"relative",overflow:o.length>0?"auto":"visible",transition:"min-height 0.3s ease"}),[t,o.length]);return s.jsxs("div",{ref:w,id:"search-results",className:`overflow-y-auto transition-all duration-300 ${e}`,style:N,"aria-live":"polite",children:[d&&s.jsxs("div",{className:"p-4 flex flex-col items-center justify-center",children:[s.jsx(_,{size:"medium",className:"text-primary mb-2"}),s.jsx("p",{className:"text-center text-gray-500",children:y?.getMessage()||i?.loadingText||"Searching..."})]}),!d&&a&&s.jsx("div",{className:"flex items-center justify-center p-4",children:s.jsx($,{message:typeof a=="string"?{type:"error",text:a}:a?.text?a:{type:"error",text:"An error occurred during search"}})}),!d&&!a&&l&&s.jsx("div",{className:"flex flex-col items-center justify-center w-full py-4",role:"alert",children:s.jsxs("div",{children:[s.jsx($,{message:l}),l&&l.type==="error"&&l.text&&l.text.includes("Can't find")&&s.jsxs("div",{className:"mt-3 text-sm",children:[s.jsx("p",{children:"Suggestions:"}),s.jsxs("ul",{className:"list-disc pl-5 mt-1",children:[s.jsx("li",{children:"Check for spelling errors"}),s.jsx("li",{children:"Try using fewer or different keywords"}),s.jsx("li",{children:"Try searching for part of the name"})]})]})]})}),!d&&!a&&!l&&M&&s.jsx("div",{className:"transition-opacity duration-300 w-full",children:b})]})},Z=k.memo(Re),ee=n.forwardRef(({name:e,label:t,labelClassName:c="",containerClassName:u="",validation:o={},customConfig:d=null,onSearch:a,onSelectItem:l,onCancel:i,errorMessage:h="This field is required. Please enter a value.",resultsClassName:y="",searchBarClassName:g="",labelPosition:x="above",showMessage:S=!0,formError:w=null,message:C=null},M)=>{const{register:p,setValue:m,formState:{errors:r},trigger:f}=ue(),b=n.useCallback(F=>{F&&F.id&&(m(e,F.id,{shouldValidate:!0}),f(e)),l&&l(F)},[l,m,e,f]),N=n.useCallback(F=>{F&&F.id&&(m(e,F.id,{shouldValidate:!0}),f(e)),a&&a(F)},[a,f,m,e]),j=n.useCallback(()=>{i&&i()},[i]);n.useEffect(()=>{p(e,o)},[p,e,o]);const R=n.useMemo(()=>w||(r[e]?{type:"error",text:r[e].message||h}:null)||(C&&C.text?C:null),[w,r,e,h,C]),T=n.useMemo(()=>t?s.jsx("label",{htmlFor:e,className:`form-label ${x==="above"?"mb-1":"mr-2"} text-sm font-medium ${c}`,children:t}):null,[t,x,c,e]),v=n.useMemo(()=>!S||!R?null:s.jsx($,{message:R}),[S,R]);return s.jsx(te,{customConfig:d,children:s.jsxs("div",{className:`form-control ${u}`,children:[T,s.jsx("input",{type:"hidden",id:e,name:e,"aria-hidden":"true",ref:M}),s.jsx(Y,{className:g,ariaLabel:t||"SÃ¶k",autoFocus:!0}),s.jsx(Z,{className:`mt-2 ${y}`,maxHeight:"60vh",onItemSelect:b}),s.jsx("div",{className:"mt-4",children:s.jsx(A,{onAction:N,onCancel:j})}),v]})})});ee.displayName="SearchField";k.memo(ee);function Ne(e){const[t,c]=n.useState(""),[u,o]=n.useState([]),[d,a]=n.useState(u[0]),[l,i]=n.useState(!1),[h,y]=n.useState(null),[g,x]=n.useState(null),[S,w]=n.useState(!1),C=n.useRef(null),M=n.useRef(""),p=n.useRef(null);n.useEffect(()=>()=>{p.current&&clearTimeout(p.current)},[]);const m=n.useCallback(async j=>{if(!j.trim()||!e?.searchFn)return;const R=Date.now();C.current=R,i(!0),y(null);try{const T=await e.searchFn(j);if(C.current!==R)return;T?.success?(o(T.data||[]),T.data&&T.data.length>0?(a(T.data[0]),x(null)):(a(null),x({type:"error",text:e.noResultsText||"No results found"}))):(o([]),a(null),x({type:"error",text:T.message||e.noResultsText||"No results found"}))}catch(T){C.current===R&&(console.error("Search error:",T),y(T),o([]),a(null))}finally{C.current===R&&i(!1)}},[e]),r=n.useCallback(()=>{p.current&&(clearTimeout(p.current),p.current=null),o([]),a(null),y(null),x(null),C.current=null},[]),f=n.useCallback(j=>{const R=j.target.value;if(R===t)return;if(c(R),M.current=R,p.current&&(clearTimeout(p.current),p.current=null),!R.trim()){w(!1),r();return}w(!0);const T=400;p.current=setTimeout(()=>{R.trim()&&(w(!1),m(R))},T)},[m,r,t]),b=n.useCallback(j=>{j&&a(j)},[]),N=n.useCallback(j=>!j||!d?!1:j[e?.idField||"id"]===d[e?.idField||"id"],[d,e?.idField]);return n.useMemo(()=>({query:t,results:u,selectedItem:d,isLoading:l,isTyping:S,error:h,message:g,handleInputChange:f,handleSelectItem:b,setSelectedItem:a,isItemSelected:N,resetSearch:r,performSearch:m,config:e}),[t,u,d,l,S,h,g,f,b,N,r,m,e])}const Me=(e={})=>{const t=X({autoGetUserLocation:!0,...e}),{userLocation:c,calculateDistance:u}=t,o=n.useCallback(async(a,l)=>{if(a.latitude&&a.longitude){const i=u(l.latitude,l.longitude,a.latitude,a.longitude);return{...a,distance:i}}if(a.postCode)try{const i=await E.get(`/api/stable-location/${a.postCode}`);if(i.isSuccess&&i.value){const h=i.value;if(h.latitude&&h.longitude){const y=u(l.latitude,l.longitude,h.latitude,h.longitude);return{...a,latitude:h.latitude,longitude:h.longitude,distance:y}}}}catch(i){console.error("Error fetching location data:",i)}else try{const i=await E.get(`/api/stable/${a.id}`);if(i.isSuccess&&i.value?.postCode){const h=i.value,y=await E.get(`/api/stable-location/${h.postCode}`);if(y.isSuccess&&y.value){const g=y.value;if(g.latitude&&g.longitude){const x=u(l.latitude,l.longitude,g.latitude,g.longitude);return{...a,postCode:h.postCode,latitude:g.latitude,longitude:g.longitude,distance:x}}}}else console.warn("Stable details missing postcode or request failed:",i)}catch(i){console.error("Error fetching stable details or location:",i)}return a},[u]);return{searchConfig:n.useMemo(()=>{const a=V();return{...a,searchFn:async i=>{const h=await a.searchFn(i);if(h.success&&c){const y=await Promise.all(h.data.map(g=>o(g,c)));h.data=y}return h},resultItemRenderer:J}},[c,o]),...t}},ke=({children:e,customConfig:t=null})=>{const c=le(),u=n.useMemo(()=>t||pe(c.pathname),[t,c.pathname]),o=u?.entityType==="stable",d=Me(),a=o?d.searchConfig:u,l=Ne(a),i=z(l.isLoading,"fetch"),h=n.useMemo(()=>({...l,loading:l.isLoading,loadingState:i,config:a}),[l,i,a]);return s.jsx(Q.Provider,{value:h,children:e})},te=k.memo(ke),Le=({formMethods:e,onSubmit:t,onCancel:c,isLoading:u=!1,loadingState:o=null,error:d=null,message:a=null,inputClassName:l="",desktopView:i=!1})=>{const[h,y]=n.useState(!1),[g,x]=n.useState(null),{sendJoinRequest:S,loading:w,error:C,message:M,loadingState:p}=he(),m=w||u,r=w?p:o,f=C||d,b=M||a,N={...B.stable,loading:m,loadingState:r},j=n.useCallback(I=>{x(I),y(!0)},[]),R=n.useCallback(async()=>{if(!g)return;const I=await S(g);setTimeout(()=>{y(!1),t&&t({...g,action:"request",requestSent:I.success,result:I})},1500)},[g,S,t]),T=()=>{c&&c()},v=typeof f=="string"?{type:"error",text:f}:f,F={"aria-busy":m?"true":"false"};return m&&r&&(F["aria-live"]="polite"),s.jsxs("div",{children:[!i&&s.jsx("div",{className:"bg-background",children:s.jsx(re,{title:"Join a Stable"})}),s.jsxs(ie,{methods:e,className:"w-full",children:[s.jsx("div",{...F,children:s.jsx(te,{customConfig:N,children:s.jsxs("div",{className:"space-y-10 mt-5 ",children:[s.jsx("div",{children:s.jsx(Y,{className:"w-full",inputClassName:`w-full bg-white ${l}`,ariaLabel:"Search for stable name",autoFocus:!i,desktopView:i,maintainFocus:!i,disabled:m})}),m&&r&&s.jsx("div",{className:"sr-only","aria-live":"polite",children:r.getMessage()||"Loading..."}),s.jsx(Z,{className:"mt-4",maxHeight:"40vh",showWhenEmpty:!1,onItemSelect:j}),v&&s.jsx($,{message:v}),b&&b.text&&!v&&s.jsx($,{message:b}),s.jsx("div",{className:"mt-6",children:i?s.jsx("div",{className:"hidden",children:s.jsx(A,{onCancel:T,loading:m,loadingState:r,disabled:m})}):s.jsx(A,{onCancel:T,loading:m,loadingState:r,disabled:m})})]})})}),s.jsx(oe,{isOpen:h,onClose:()=>{y(!1),x(null)},onConfirm:R,loading:m,title:"Request to join stable?",confirmButtonText:"Send Request",confirmButtonType:"primary",cancelButtonText:"Cancel",icon:s.jsx(ce,{size:70,backgroundColor:"bg-primary",iconColor:"text-white"}),children:g&&s.jsxs("div",{className:"text-center space-y-2",children:[s.jsx("p",{className:"font-medium",children:g.name}),g.type&&s.jsx("p",{className:"text-gray",children:g.type}),g.county&&s.jsx("p",{className:"text-gray",children:g.county}),s.jsx("p",{className:"text-sm text-gray mt-4",children:"The stable administrator will need to approve your request before you can access it."})]})})]})]})},Ue=k.memo(Le);export{Ue as J,fe as S,X as u};

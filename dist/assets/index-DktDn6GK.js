import{r as e,j as t,f as r,g as s}from"./vendor-react-B_QZno8V.js";import{a as o,U as a,A as l,t as n,k as c,l as i,n as u,v as d,o as m,p as f,q as p,r as g}from"./form-components-BwsA2IIA.js";import"./ui-components-3MKBAZVk.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver((e=>{for(const r of e)if("childList"===r.type)for(const e of r.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)})).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const h=({children:r})=>{const{user:s}=o(),[n,c]=e.useState((()=>{const e=localStorage.getItem("currentStable");return e?JSON.parse(e):null})),[i,u]=e.useState(0),[d,m]=e.useState(null),[f,p]=e.useState(!1),g=e.useCallback(((e,t="")=>{const r=sessionStorage.getItem("newStableCreated"),o="true"===r&&null!==r;if(!(f||o)&&(null==s?void 0:s.stableRoles)&&void 0===s.stableRoles[e])return localStorage.removeItem("currentStable"),c(null),!1;o&&sessionStorage.removeItem("newStableCreated");const a={id:e,name:t};return c(a),localStorage.setItem("currentStable",JSON.stringify(a)),u((e=>e+1)),!0}),[null==s?void 0:s.stableRoles,f,c,u]);e.useEffect((()=>{const e=localStorage.getItem("currentStable");if(e)try{const t=JSON.parse(e);(null==s?void 0:s.stableRoles)&&void 0===s.stableRoles[t.id]&&(localStorage.removeItem("currentStable"),c(null))}catch(t){localStorage.removeItem("currentStable"),c(null)}}),[null==s?void 0:s.stableRoles]);const h=e.useCallback((()=>{if(!n||!(null==s?void 0:s.stableRoles))return a.USER;const e=s.stableRoles[n.id];return void 0!==e?e:a.USER}),[null==s?void 0:s.stableRoles,n]),b={currentUser:s,currentStable:n,changeStable:g,enableSecurityBypass:()=>{p(!0),setTimeout((()=>p(!1)),2e3)},selectedHorse:d,setSelectedHorse:m,getCurrentStableRole:h,stableRefreshKey:i,UserRoles:a};return t.jsx(l.Provider,{value:b,children:r})},b=e=>{try{const t=e.split(".");if(t.length<2)return null;const r=t[1].replace(/-/g,"+").replace(/_/g,"/"),s=r.padEnd(r.length+(4-r.length%4),"=");return JSON.parse(window.atob(s))}catch(t){return null}},S=({children:r})=>{const[s,o]=e.useState(null),[a,l]=e.useState(!0),[d,m]=e.useState(null),[f,p]=e.useState(!1),g=e.useCallback((async()=>{try{const e=n.getAccessToken();if(!e)return o(null),sessionStorage.removeItem("currentUser"),l(!1),!1;const t=b(e);if(!t||1e3*t.exp<=Date.now())return n.removeAccessToken(),o(null),sessionStorage.removeItem("currentUser"),l(!1),!1;{const r=t.sub,s={id:r,firstName:t.firstName,lastName:t.lastName,email:t.email,phoneNumber:t.phoneNumber,token:e};sessionStorage.setItem("currentUser",JSON.stringify(s));try{const e=await c.getById(r),a=(null==e?void 0:e.value)||{},l=await c.getUserStables(r),n=Array.isArray(l)?l.reduce(((e,t)=>(e[t.stableIdFk]=t.role,e)),{}):{},i={...s,stableRoles:n,isNewUser:0===Object.keys(n).length};o(i),sessionStorage.setItem("currentUser",JSON.stringify(i)),o({...s,firstName:a.firstName||t.firstName,lastName:a.lastName||t.lastName,email:a.email||t.email,phoneNumber:a.phoneNumber||t.phoneNumber,profilePictureUrl:a.profilePictureUrl||t.profilePictureUrl,stableRoles:n})}catch{o({...s,stableRoles:{}})}return l(!1),!0}}catch(e){return n.removeAccessToken(),o(null),sessionStorage.removeItem("currentUser"),l(!1),!1}}),[]),h=e.useCallback((async()=>{try{const t=n.getAccessToken("authToken");if(n.removeAccessToken(),o(null),p(!1),d&&(clearTimeout(d),m(null)),t)try{await i.logout(t)}catch(e){}return!0}catch(e){return!1}}),[d]),S=e.useCallback((async()=>{try{const e=n.getAccessToken();if(!n.getRefreshToken()||!e)return!1;const t=b(e);if(!t||!t.exp)return!1;const r=await i.refreshToken();if(r&&r.isSuccess&&r.value)return!0;const s=Date.now();return 1e3*t.exp>s}catch(e){return!1}}),[]),v=e.useCallback((()=>{d&&(clearTimeout(d),m(null)),p(!1)}),[d]);e.useEffect((()=>{g()}),[g]),e.useEffect((()=>{let e=null;const t=()=>{const r=(()=>{try{const e=n.getAccessToken();if(!e)return null;const t=b(e);if(!t||!t.iat||!t.exp)return null;const r=1e3*t.iat,s=1e3*t.exp,o=Date.now(),a=s-r;return s-o<=0?null:Math.floor(.95*a)}catch(e){return null}})();if(!r)return null;e&&clearInterval(e),e=setInterval((async()=>{try{if(!(await S())&&s){const e=await i.refreshToken();e&&e.isSuccess&&t()}}catch(e){}}),r)};return s&&t(),()=>{e&&clearInterval(e)}}),[s,S]);const w=e.useCallback((async(e,t)=>{var r,s;try{l(!0);const o=await i.login({email:e,password:t});if(!o)throw new Error("Login failed: No response from server");const a=null==(r=null==o?void 0:o.value)?void 0:r.accessToken,c=null==(s=null==o?void 0:o.value)?void 0:s.refreshToken;if(!a||!c)throw new Error("Authentication failed: Invalid token response");n.setAccessToken(a),n.setRefreshToken(c),await g();return{success:!0,hasStable:!!localStorage.getItem("currentStable")}}catch(o){throw o}finally{l(!1)}}),[g]),y=e.useCallback((async(e,t={})=>{let r=await g();if(!r)try{const e=await i.refreshToken();e&&e.isSuccess&&(r=await g())}catch(l){}if(!r)throw new Error("Session expired. Please log in again.");const s=n.getAccessToken(),o={...t,headers:{...t.headers,Authorization:`Bearer ${s}`}},a=await fetch(e,o);if(401===a.status)throw await h(),new Error("Session expired. Please log in again.");return a}),[g,h]),k=e.useMemo((()=>({user:s,isLoading:a,login:w,logout:h,authFetch:y,verifyToken:g,checkAndRefreshToken:S,extendSession:v,isAuthenticated:!!s,showSessionWarning:f})),[s,a,w,h,y,g,S,v,f]);return t.jsx(u.Provider,{value:k,children:r})},v=e.createContext(),w=({children:r})=>{const[s,o]=e.useState({}),[a,l]=e.useState({}),n=e.useCallback((async(e,t,r)=>{try{const s=`upload_${Date.now()}`;let a;if(o((t=>({...t,[s]:{progress:0,fileName:e.name,status:"preparing"}}))),"profile-picture"===t&&r){const t=e.name.split(".").pop().toLowerCase(),s=d();a=`profile-pictures/${r}/${s}.${t}`}else a=m(e);const l=await f(a);if(!l)throw new Error("Failed to get upload URL");o((e=>({...e,[s]:{...e[s],status:"uploading",blobName:a}})));const n=await p(e,l,a,(e=>{o((t=>({...t,[s]:{...t[s],progress:e}})))}));return o((e=>({...e,[s]:{...e[s],status:"completed",progress:100,url:n.url,blobName:a}}))),{success:!0,uploadId:s,url:n.url,blobName:a}}catch(s){return l((t=>({...t,[e.name]:s.message||"Upload failed"}))),{success:!1,error:s.message}}}),[]),c=e.useCallback((e=>{o((t=>{const r={...t};return delete r[e],r}))}),[]),i=e.useCallback((e=>{l((t=>{const r={...t};return delete r[e],r}))}),[]),u=e.useMemo((()=>({uploads:s,uploadErrors:a,uploadFile:n,clearUpload:c,clearError:i})),[s,a,n,c,i]);return e.useEffect((()=>(window.__fileUploadContext={...u,uploadFile:(e,t,r)=>n(e,t,r)},()=>{delete window.__fileUploadContext})),[u,n]),t.jsx(v.Provider,{value:u,children:r})};r.createRoot(document.getElementById("root")).render(t.jsx(e.StrictMode,{children:t.jsx(S,{children:t.jsx(h,{children:t.jsx(w,{children:t.jsx(s,{router:g})})})})}));
